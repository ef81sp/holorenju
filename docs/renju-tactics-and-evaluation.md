# 連珠の戦術とAI評価

このドキュメントでは、連珠の戦術的概念とそれがAI評価関数にどのように反映されているかを説明します。

## パターンの分類

### 連（れん）の種類

連珠では、石の並びを「連」と呼び、開き具合によって価値が大きく異なります。

| 名称   | 形の例   | 説明                           | 価値         |
| ------ | -------- | ------------------------------ | ------------ |
| 活四   | `_●●●●_` | 両端が空いた四連。次で必ず五連 | 最高（勝確） |
| 止め四 | `X●●●●_` | 片端のみ空いた四連             | 高い         |
| 活三   | `_●●●_`  | 両端が空いた三連。伸ばすと活四 | 高い         |
| 止め三 | `X●●●_`  | 片端のみ空いた三連             | **低い**     |
| 活二   | `_●●_`   | 両端が空いた二連               | 中程度       |
| 止め二 | `X●●_`   | 片端のみ空いた二連             | 低い         |

※ `_` = 空き、`X` = 相手石または盤端

### 跳びパターン

1マス空いた形も脅威として重要です。

| 名称   | 形の例             | 説明               |
| ------ | ------------------ | ------------------ |
| 跳び四 | `●●●_●`, `●●_●●`   | 空きを埋めると五連 |
| 跳び三 | `_●●_●_`, `_●_●●_` | 空きを埋めると四連 |

## 止め三と剣先

### 剣先とは

止め三（片端が塞がった三連）を**剣先（けんさき）**と呼びます。

```
剣先の形:
X●●●_   ← 片端が塞がった三連

伸ばすと止め四になる:
X●●●●_  → 相手に止められると X●●●●○ で行き止まり
```

### 剣先の価値

剣先自体は**四追いのタネ**として価値があります。複数の剣先があれば、連続して四を打つVCF（四追い勝ち）の起点になります。

ただし、剣先は多くの場合**活三を止められることで自然にできる**ものです：

```
活三を打つ:
_●●●_   ← 活三

相手が片方を止める:
○●●●_   ← 剣先ができた（副産物）
```

### なぜ止め二から剣先を作る価値は低いのか

止め二からわざわざ剣先を作ることには、あまり価値がありません：

```
止め二から剣先を作る:
X●●_  →  X●●●_

この1手で得られるのは「将来の四追いのタネ」のみ
攻撃的な脅威にならず、相手は無視できる
```

活三なら相手は止めなければ四になりますが、止め三は放置しても即座に負けません。

### AI評価での対応

```typescript
// PATTERN_SCORES
THREE: 30,       // 止め三（旧: 100）
OPEN_THREE: 1000, // 活三
OPEN_TWO: 50,    // 活二
```

止め三（30点）は活二（50点）より低く設定されています。これは：

- 止め二から止め三を作る手より、活二を維持・発展させる方が有望
- 剣先は活三を止められた副産物として自然にできることが多い
- わざわざ作るほどの価値はない

## 単発四の問題

### 単発四とは

**四三**（四と活三を同時に作る）でもなく、**VCF**（四追い勝ち）に繋がるわけでもない、単独で打つ四のことです。

```
盤面例:
. . . . . . .
. . ○ . . . .
. . . ○ . . .
. . . . ○ . .
. . . . . ○ .   ← ここに白を置くと斜め四連
. . . . . . .

この四は：
- 黒に止められて終わり
- 後続の攻撃手段がない
```

### なぜ単発四は悪手なのか

1. **攻撃リソースの浪費**: 四は本来、トドメか連続攻撃に使うべき
2. **相手の石を増やす**: 相手は防御で石を置ける
3. **手番を失う**: 防御されると相手の手番になる

実際の対局では、単発四は「何もせず相手に手を渡す」のとほぼ同じです。

### AI評価での対応

```typescript
// 難易度別の単発四ペナルティ倍率
beginner: { singleFourPenaltyMultiplier: 1.0 },  // ペナルティなし
easy:     { singleFourPenaltyMultiplier: 1.0 },  // ペナルティなし
medium:   { singleFourPenaltyMultiplier: 0.1 },  // 90%減点（100点残る）
hard:     { singleFourPenaltyMultiplier: 0.0 },  // 100%減点（0点）
```

hardでは単発四は完全に無価値（0点）として扱われます。

### 後続脅威の判定

ただし、四を打った後に「後続脅威」がある場合はペナルティを適用しません。

```typescript
// hasFollowUpThreat の判定
// 四の防御位置に相手が置いた後、周囲で次の四を作れるか

// 判定条件（厳格）:
// - 次の「四」を作れる場合のみ後続脅威あり
// - 活三だけでは四追い(VCF)にならないので、後続脅威とみなさない
```

## VCF（四追い勝ち）

### 概念

VCF = Victory by Continuous Fours

連続して四を打ち続け、相手が防御し続けても最終的に五連を作れる勝ち筋。

```
VCFの例:
1. 白が四を作る → 黒が止める
2. 白が別の四を作る → 黒が止める
3. 白が四を作る → 黒が止める
4. 白が五連を作る（勝ち）
```

### 特徴

- **絶対的な勝ち**: 相手が最善を尽くしても勝てる
- **計算可能**: 終端が明確なので探索で確認できる
- **黒の禁手に注意**: 黒がVCFを狙う場合、四四禁や三三禁に注意

### AI実装

```typescript
// vcf.ts: 深さ8手までのVCF探索
// フクミ手: 次にVCFがある手に +1500 ボーナス (FUKUMI_BONUS)
```

## VCT（三四連続勝ち）

### 概念

VCT = Victory by Continuous Threats

四と活三を組み合わせて連続攻撃し、相手が防御し続けても最終的に勝てる勝ち筋。

```
VCTの例:
1. 白が活三を作る → 黒が止める
2. 白が四を作る → 黒が止める
3. 白が活三を作る → 黒が止める
4. 白が四三を作る（勝ち）
```

### VCFとの違い

| 項目       | VCF        | VCT                      |
| ---------- | ---------- | ------------------------ |
| 使う手     | 四のみ     | 四 + 活三                |
| 難易度     | 比較的簡単 | 複雑                     |
| 探索コスト | 低い       | 高い                     |
| 確実性     | 確定勝ち   | 相手のミスが必要な場合も |

### AI実装

```typescript
// vct.ts: 深さ4手までのVCT探索
// 終盤（石数20個以上）で +8000 ボーナス (VCT_BONUS)
```

## ミセ手

### 概念

次の手で**四三**を作れる位置。四三は活四と活三を同時に作るため、相手は防御できません。

```
ミセ手の例:
. . . . .
. ○ . . .
. . ○ . .
. . . * .   ← ここがミセ手
. . . . ○

*に置くと、斜めに四ができつつ、縦に活三ができる
→ 四三で勝ち確定
```

### AI実装

```typescript
// ミセ手: +1000 ボーナス (MISE_BONUS)
// 相手のミセ手を止めない手は -Infinity（除外）
```

## 禁手追い込み（白番の戦術）

### 概念

白は禁手がないため、黒の禁手（三三禁、四四禁、長連禁）を利用して勝つ戦術が可能です。

### パターン1: 防御位置が禁手

```
白の四に対して、黒の防御位置が禁手の場合：
. . . ○ ○ ○ ○ _    ← 黒は_に置けない（三三禁など）
                    → 白の勝ち
```

### パターン2: 禁手への誘導セットアップ

```
白の活三を伸ばすと、黒の防御位置が禁手になるセットアップ：
. . _ ○ ○ ○ _      ← 白が活三を伸ばすと...
. . ○ ○ ○ ○ _      ← 黒は_に置けない
```

### AI実装

```typescript
// 防御位置が禁手: +5000 (FORBIDDEN_TRAP_STRONG)
// 誘導セットアップ: +1500 (FORBIDDEN_TRAP_SETUP)
```

## 必須防御ルール

### 概念

相手の脅威を放置すると負けるため、特定の状況では防御が必須です。

| 相手の脅威 | 対応                   |
| ---------- | ---------------------- |
| 活四       | 防御不可能（負け確定） |
| 止め四     | 止め位置に置く         |
| 活三       | 両端のどちらかに置く   |
| ミセ手     | ミセ手の位置に先に置く |

### AI実装

```typescript
// 必須防御を怠る手は -Infinity（候補から除外）
// ただし、自分が先に勝てる場合（活四、四三、VCF）は例外
```

## 複数方向脅威

### 概念

2方向以上で同時に脅威を作ると、相手は1つしか防御できません。

```
例: 縦と横に同時に活三
    |
○ ○ ○ _
    |
    ○
    |
    ○
    |
    _

相手は縦か横のどちらかしか止められない
```

### AI実装

```typescript
// 2方向以上の脅威: +500 × (方向数 - 1) (MULTI_THREAT_BONUS)
```

## 斜め方向の優位性

### 概念

斜め方向の連は、縦横の連より若干有利です。

理由：

- 隣接する空き点が多い
- 複合的な脅威を作りやすい
- 相手の防御が見落とされやすい

### AI実装

```typescript
// 斜め方向のパターン: +5% ボーナス (DIAGONAL_BONUS_MULTIPLIER)
```

## カウンターフォー

### 概念

相手の攻撃を防御しながら、同時に自分の四を作る手。

```
例:
○ ○ ○ _     ← 黒の活三
. . . ●     ← ここに白を置くと...
    . ●
      ●
      _

黒の活三を止めつつ、白の縦四ができる
```

### AI実装

```typescript
// 防御しながら四を作る: 防御スコア × 1.5 (COUNTER_FOUR_MULTIPLIER)
```

## 評価関数のスコア一覧

現在の実装における各パターン・ボーナスのスコア：

| 項目                  | スコア  | 説明                           |
| --------------------- | ------- | ------------------------------ |
| FIVE                  | 100,000 | 五連（勝利）                   |
| OPEN_FOUR             | 10,000  | 活四                           |
| FORBIDDEN_TRAP_STRONG | 8,000   | 禁手追い込み（防御位置が禁手） |
| VCT_BONUS             | 8,000   | VCT勝ち筋                      |
| FOUR_THREE_BONUS      | 5,000   | 四三同時作成                   |
| FUKUMI_BONUS          | 1,500   | フクミ手（次にVCF）            |
| FORBIDDEN_TRAP_SETUP  | 1,500   | 禁手誘導セットアップ           |
| MISE_BONUS            | 1,000   | ミセ手（次に四三）             |
| FOUR                  | 1,000   | 止め四                         |
| OPEN_THREE            | 1,000   | 活三                           |
| MULTI_THREAT_BONUS    | 500     | 複数方向脅威（方向あたり）     |
| OPEN_TWO              | 50      | 活二                           |
| THREE                 | 30      | 止め三                         |
| TWO                   | 10      | 止め二                         |
| CENTER_BONUS          | 5       | 中央寄りボーナス               |

## 関連ファイル

| ファイル                      | 内容                   |
| ----------------------------- | ---------------------- |
| `src/logic/cpu/evaluation.ts` | 評価関数、パターン検出 |
| `src/logic/cpu/search/vcf.ts` | VCF探索                |
| `src/logic/cpu/search/vct.ts` | VCT探索                |
| `src/logic/renjuRules.ts`     | 禁手判定、パターン検出 |
| `src/types/cpu.ts`            | 難易度パラメータ       |
