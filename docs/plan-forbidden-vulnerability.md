# 禁手回避ロジック強化プラン

## 背景

hard vs hard 200局のベンチマークで42局（21%）が禁手追い込みで黒が敗北。前回推定11%から倍増。38%が16手以内の早期追い込み。

`9b2b8f3`で「白の三三脅威検出と必須防御」を実装したことで白の攻撃力が向上したが、黒の禁手回避能力が追いついていない。

## Phase 0 結果: 影響切り分け ✅

`enableDoubleThreeThreat: false` で200局ベンチマークを実施（`bench-2026-02-20T05-10-52-217Z.json`）。

| 指標               | 三三脅威 ON (baseline) | 三三脅威 OFF   | 差分   |
| ------------------ | ---------------------- | -------------- | ------ |
| 禁手追い込み率     | 42/200 (21.0%)         | 31/200 (15.5%) | -5.5pp |
| 黒勝率             | 57.0%                  | 52.0%          | -5.0pp |
| 16手以内追い込み率 | 16/42 (38%)            | 9/31 (29%)     | -9pp   |

**分析**:

- 三三脅威検出を無効にしても禁手追い込み率は15.5%（判断基準: 15%以上 → 黒の回避能力の問題としてPhase 1に進む）
- 三三脅威検出は約11件（21%-15.5%≈5.5pp）の追加禁手追い込みの原因
- **黒の構造的な禁手回避能力不足が主因**（ベースラインで15.5%）
- 三三脅威検出側の調整は当面不要（ボーダーラインだが、Phase 1の効果を先に確認）

**判断**: プラン通りPhase 1（パラメータ調整）に進む。

## 根本原因

> **レビュー指摘（イシュー）**: 禁手追い込みは白の正当な勝ち筋であり、一定割合の発生は自然。11%→21%の増加のうち、白の三三脅威検出の副作用が何割で、黒の本質的な回避能力不足が何割かの切り分けが必要。

→ Phase 0で切り分け完了: **三三脅威検出=26%（11/42件）、構造的問題=74%（31/42件）**

1. **ペナルティの相対的な弱さ**: 黒の脆弱性ペナルティ `FORBIDDEN_VULNERABILITY_STRONG`(800) は `FOUR`(1500) + `OPEN_THREE`(1000) の攻撃スコアに対して小さく、攻撃的な手が脆弱性を上回りやすい
2. **ペナルティ上限が低い**: `FORBIDDEN_VULNERABILITY_CAP`(1500) で頭打ちになり、複数方向の脆弱性が累積しない
3. **近傍チェックが浅い**: 延長点の先2マスのみで白の攻撃ラインを評価

> **レビュー指摘（イシュー）**: 当初の根本原因1「TRAP_STRONG(8000) vs VULNERABILITY_STRONG(800) = 10倍の非対称」はカテゴリーエラー。TRAP_STRONGは「確定的な勝ち」、VULNERABILITYは「潜在リスク」であり、10倍差は設計上意図的。

## 実装計画

### ~~Phase 0: 影響切り分けベンチマーク~~ ✅ 完了

### Phase 1: パラメータ調整（TDD）

**ファイル**: `src/logic/cpu/evaluation/patternScores.ts`

> **レビュー指摘（イシュー）**: パラメータは控えめに開始すべき。探索ツリー内でも `evaluatePosition` から呼ばれるため、変更の影響はルートレベルだけでなく全探索に波及する。

```typescript
// 変更前
FORBIDDEN_VULNERABILITY_STRONG: 800,
FORBIDDEN_VULNERABILITY_MILD: 300,
FORBIDDEN_VULNERABILITY_CAP: 1500,

// 変更後（控えめ）
FORBIDDEN_VULNERABILITY_STRONG: 1000,
FORBIDDEN_VULNERABILITY_MILD: 400,
FORBIDDEN_VULNERABILITY_CAP: 2000,
```

**根拠**:

- STRONG 800→1000: FOUR(1500)に対して2/3程度のペナルティ。攻撃力を大きく損なわない範囲で回避行動を促す
- MILD 300→400: 軽微な脆弱性でも差が出る水準に微増
- CAP 1500→2000: 2方向以上の脆弱性で FOUR+OPEN_THREE(2500) の攻撃に対抗できるように

**テスト先行**:

- 既存の `forbiddenTactics.test.ts` でスコア値の更新
- STRONG脆弱性がある手のスコアが低下することを確認

**Phase 1完了後に必ずベンチマーク**。効果が十分（禁手追い込み率15%以下）ならPhase 2は不要。

### Phase 2: 白の攻撃ラインチェック距離拡張（Phase 1で不十分な場合のみ）

**ファイル**: `src/logic/cpu/evaluation/forbiddenTactics.ts`

> **レビュー指摘（イシュー）**: 多段階関数ではなく、`hasWhiteStoneNearExtension` のチェック距離を2マス→4マスに拡張するだけに簡素化すべき。

現在の `hasWhiteStoneNearExtension()` のチェック距離を2→4マスに拡張。

```typescript
function hasWhiteStoneNearExtension(
  board: BoardState,
  extRow: number,
  extCol: number,
  dr: number,
  dc: number,
): boolean {
  // 変更前: step <= 2
  // 変更後: step <= 4
  for (let step = 1; step <= 4; step++) {
    const r = extRow + dr * step;
    const c = extCol + dc * step;
    if (!isValidPosition(r, c)) break;
    if (board[r]?.[c] === "white") return true;
  }
  return false;
}
```

**テスト先行**:

- 距離3-4の白石を検出するテスト
- 距離5以上は検出しないテスト

### ~~Phase 3: 予見的脆弱性評価~~ （削除）

> **レビュー指摘（全3レビュワー一致）**: Phase 3は削除。理由:
>
> 1. **SRP違反**: 静的評価モジュール(`evaluation/`)に探索ロジックを混在させる
> 2. **逆方向依存**: `evaluation/` → `search/threatPatterns.ts` の依存が循環リスクを生む
> 3. **計算コスト**: `evaluatePosition` から全候補手×全深度で呼ばれると5-10倍のコスト増。「+15%以内」は非現実的
> 4. **存在しない関数**: `findOpenThreeMoves`, `getDefensePositions` が未実装
> 5. **undo順序バグ**: `evaluatePositionCore` 内で既に石が置かれた後にさらに仮配置するとundo順序が破綻する
> 6. **探索との役割重複**: minimax探索が既に1-2手先を見ているのに、評価関数内でさらにシミュレートするのは役割分担を破壊する
>
> **代替**: 禁手脆弱性が高い局面での静止探索延長（horizon effectプラン側で対応）を将来課題として記録。

### Phase 3: ベンチマーク検証

Phase 1（-2）の各段階後に `pnpm bench --self --players=hard --games=200 --parallel` を実行し、禁手追い込み率の推移を確認。

**副作用チェック**: 禁手追い込みされない局での黒勝率が低下していないことを確認。

## テスト戦略

1. **ユニットテスト** (`forbiddenTactics.test.ts`):
   - Phase 1: スコア定数変更後の評価値テスト
   - Phase 2: チェック距離拡張のテスト

2. **ベンチマーク**: 各Phase後に200局ベンチ

## 検証指標

> **レビュー指摘（イシュー）**: 黒勝率65%目標は不適切。hard vs hard の連珠（禁手あり）で55-60%が健全な範囲。禁手追い込みは白の正当な勝ち筋なので、最終目標も12-16%が現実的。

| 指標                 | 現在         | Phase 0結果         | Phase 1目標    | 最終目標                 |
| -------------------- | ------------ | ------------------- | -------------- | ------------------------ |
| 禁手追い込み率       | 21% (42/200) | 15.5% (三三脅威OFF) | 15-18%         | 12-16%                   |
| 16手以内追い込み率   | 38% (16/42)  | 29% (9/31)          | 25-30%         | 20-25%                   |
| 黒勝率               | 57%          | 52% (三三脅威OFF)   | 55-60%         | 55-60%（低下しないこと） |
| 非追い込み局の黒勝率 | 未計測       | 未計測              | 低下しないこと | 低下しないこと           |
| 1手あたり評価時間    | 基準         | 基準                | +5%以内        | +5%以内                  |

## 主要ファイル

| ファイル                                            | 変更内容                                    |
| --------------------------------------------------- | ------------------------------------------- |
| `src/logic/cpu/evaluation/patternScores.ts`         | パラメータ調整                              |
| `src/logic/cpu/evaluation/forbiddenTactics.ts`      | チェック距離拡張（Phase 2、必要な場合のみ） |
| `src/logic/cpu/evaluation/forbiddenTactics.test.ts` | テスト追加                                  |
