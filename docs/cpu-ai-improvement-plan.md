# CPU AIアルゴリズム改善計画

## 概要

`docs/cpu-ai-algorithm.md` に記載された未実装機能を全て実装するための計画。
4つのステップに分けて段階的に実装を進める。

## ステップ構成

| ステップ | 優先度 | 機能 | 計画ファイル |
|---------|--------|------|-------------|
| **1** | 最高 | 跳び三・跳び四検出、四三同時作成ボーナス | [cpu-ai-step1-jump-patterns.md](./cpu-ai-step1-jump-patterns.md) |
| **2** | 高 | 白の三三四四勝利、禁手追い込み、ミセ手・フクミ手 | [cpu-ai-step2-white-forbidden.md](./cpu-ai-step2-white-forbidden.md) |
| **3** | 中 | 複数方向脅威、カウンターフォー、VCT探索 | [cpu-ai-step3-advanced-tactics.md](./cpu-ai-step3-advanced-tactics.md) |
| **4** | 低 | 斜め方向ボーナス、開局パターン評価 | [cpu-ai-step4-minor-improvements.md](./cpu-ai-step4-minor-improvements.md) |

## 主な変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/logic/cpuAI/evaluation.ts` | 評価関数の拡張（中心） |
| `src/logic/cpuAI/vcf.ts` | VCF探索（新規） |
| `src/logic/cpuAI/vct.ts` | VCT探索（新規） |
| `src/logic/cpuAI/opening.ts` | 開局評価の拡張 |
| `src/types/cpu.ts` | 型定義（必要に応じて） |

## 実装する機能一覧

### ステップ1（最高優先度）

| 機能 | 説明 | スコア |
|------|------|--------|
| 跳び四検出 | `●_●●●`, `●●_●●` | FOUR (1000) |
| 活跳び四検出 | `_●_●●●_` | OPEN_FOUR (10000) |
| 跳び三検出 | `●_●●`, `●●_●` | THREE (100) |
| 活跳び三検出 | `_●_●●_` | OPEN_THREE (1000) |
| 四三同時作成ボーナス | 四と活三を同時に作る | +5000 |

### ステップ2（高優先度）

| 機能 | 説明 | スコア |
|------|------|--------|
| 白の三三勝利 | 活三が2方向 | FIVE (100000) |
| 白の四四勝利 | 四が2方向 | FIVE (100000) |
| 禁手追い込み（強） | 黒の防御位置が禁手 | +5000 |
| 禁手追い込み（弱） | 禁手への誘導セットアップ | +1500 |
| ミセ手 | 次に四三を作れる手 | +1000 |
| フクミ手 | 次にVCFの手 | +1500 |

### ステップ3（中優先度）

| 機能 | 説明 | スコア |
|------|------|--------|
| 複数方向脅威 | 活三以上が2方向以上 | +500×(方向数-1) |
| カウンターフォー | 防御しながら四を作る | 防御スコア×1.5 |
| VCT探索 | 三・四連続勝利検出 | +8000（終盤のみ） |

### ステップ4（低優先度）

| 機能 | 説明 | スコア |
|------|------|--------|
| 斜め方向ボーナス | 斜め方向のパターン | +5% |
| 開局パターン評価 | 珠型有利不利 | ±100〜500 |

## 各ステップの検証方法

```bash
# 単体テスト
pnpm test src/logic/cpuAI/

# 型チェック・リント
pnpm check-fix

# 統合テスト（CPU対戦プレイ）
pnpm dev
```

## 進め方

1. ステップ1から順に実装
2. 各ステップ完了後にテスト・コミット
3. 次のステップに進む

## 各ステップの所要時間目安

| ステップ | 新規ファイル | 変更ファイル | 複雑度 |
|---------|------------|------------|-------|
| 1 | 0 | 2 | 中 |
| 2 | 1 (vcf.ts) | 2 | 高 |
| 3 | 1 (vct.ts) | 2 | 高 |
| 4 | 0 | 2 | 低 |

## 依存関係

```
ステップ1（跳びパターン）
    ↓
ステップ2（VCF探索）← ステップ1の跳びパターン検出を使用
    ↓
ステップ3（VCT探索）← ステップ2のVCF探索を使用
    ↓
ステップ4（開局評価）← 独立して実装可能
```

## 注意事項

### パフォーマンス

- VCF/VCT探索は計算コストが高い
- 深さ制限と時間制限を適切に設定
- 必要に応じてWeb Worker内での実行を継続

### テスト

- 各機能に対して単体テストを作成
- 実際のプレイで動作を確認
- パフォーマンステストも実施

### 後方互換性

- 既存のスコアバランスを大きく崩さない
- 難易度パラメータは変更しない
- 既存のテストが壊れないようにする
