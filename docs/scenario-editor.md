# シナリオエディタ設計

## 概要

シナリオJSONを直感的に編集できるGUIエディタ。ローカルJSONファイルを直接更新し、盤面視覚化とバリデーション機能を備える。

## 要件確定

### 1. 編集対象

- 新規シナリオ作成
- 既存シナリオの編集

## 実装状況 (2026-01-01)

### 実装済み

- ファイル操作: ローカルJSONの読込/保存、JSONコピー&ペースト、テンプレートからの新規作成
- 基本情報編集: id/title/difficulty/description/objectives のフォーム
- セクション管理: 追加・削除・選択、ID編集、タイプ変更、詳細編集エリアの分割
- 盤面エディタ: クリックで e→黒→白→空 のサイクル、座標表示、クリップボード入出力、デバッグ表示、上書き可能な盤面編集
- デモセクション: タイトル編集、初期盤面編集、ダイアログ編集（id/character/text/emotion）、boardAction（place/remove/setBoard/mark/line）の入力
- 問題セクション: 初期盤面編集、説明、成功条件（position/pattern/sequence で座標・色・手順を編集）、ヒント編集（level/dialogue/marks）、フィードバック編集（success/failure/progress の複数行）
- バリデーション: シナリオ変更時のリアルタイム検証とエラーパネル表示、保存時の再検証
- プレビュー: 選択セクションの概要と初期盤面ASCII表示

### 未実装/残タスク

- ダイアログの盤面操作プレビュー（アニメーション）
- 成功条件の視覚的表示（盤面ハイライト）
- セクション/シナリオ複製、アンドゥ・リドゥ
- 複数ファイルの一括バリデーションと連続実行テスト
- 盤面テンプレート・キャラクター画像プレビュー・盤面操作からの成功条件自動検出

### 3. 盤面入力

- クリックで石を置く/削除するGUI
- Konvaで実装（既にプロジェクトで使用中）

### 4. 盤面表示

- 編集中のデモ・問題のプレビュー表示
- 次の手を確認するマーク表示は不要

### 5. 保存形式

- ローカルJSONファイルを直接更新（ViteのVM経由で更新）

### 6. 優先度

- 最小限の機能で開始
- 段階的に拡張

## 機能要件

### 最小限機能（Phase 1）

#### 1.1 シナリオ基本情報編集

- `id`: string
- `title`: string
- `difficulty`: select (beginner | intermediate | advanced)
- `description`: textarea
- `objectives`: textarea or list

#### 1.2 セクション管理

- セクション追加ボタン
- セクション削除ボタン
- セクションタイプ選択: demo | problem
- セクション基本情報（id, type, title）

#### 1.3 デモセクション編集

- `initialBoard`: 盤面ビジュアルエディタ
  - Konvaで15x15の盤面を表示
  - クリックで黒(x) / 白(o) / 空(e) を切り替え
  - 表示形式：文字列配列に自動変換
- ダイアログリスト表示
- ダイアログ追加ボタン
- 各ダイアログの編集フォーム：
  - `id`: string
  - `character`: string
  - `text`: textarea
  - `emotion`: string (optional)

#### 1.4 問題セクション編集

- `initialBoard`: 盤面ビジュアルエディタ（デモと同じ）
- `description`: textarea
- 成功条件リスト
  - 成功条件追加ボタン
  - タイプ選択: position | pattern | sequence
  - 各タイプの入力フォーム
    - position: positions[], color
    - pattern: pattern, color
    - sequence: moves[], strict
- ヒントリスト（optional）
  - ヒント追加ボタン
  - level, dialogue, marks
- フィードバック編集
  - success: DialogueLine[]
  - failure: DialogueLine[]
  - progress: DialogueLine[] (optional)

#### 1.5 盤面ビジュアルエディタ

- 機能:
  - 15x15のマス表示
  - クリックで黒 → 白 → 空 → 黒...のサイクル
  - 座標表示（マウスホバー時）
  - 現在の盤面をテキスト表示（デバッグ用）
  - リセットボタン

#### 1.6 バリデーション

- リアルタイムバリデーション（parseScenarioを使用）
- エラー表示パネル
- 保存時に盤面バリデーション実行

#### 1.7 ファイル操作

- ローカルJSON読み込み（ファイルアップロード）
- JSON保存（ダウンロードまたは直接更新）
- 新規作成テンプレート

#### 1.8 プレビュー機能

- 現在のセクションのプレビュー
  - デモ: ダイアログとボードアクションの再生（静止画でOK）
  - 問題: 初期盤面表示

### 後からほしい機能（Phase 2+）

- ダイアログの盤面操作プレビュー（アニメーション）
- 成功条件の視覚的表示（盤面上にハイライト）
- シナリオの複製
- セクションの複製
- アンドゥ・リドゥ機能
- 複数ファイルの一括バリデーション
- シナリオの連続実行テスト
- 盤面のテンプレート（よくある初期盤面）
- ダイアログのキャラクター画像プレビュー
- 手動での盤面操作で成功条件を自動検出

## UI構成案

```
┌─────────────────────────────────────────────────┐
│ シナリオエディタ                    [ファイル選択]│
├──────────────────┬──────────────────────────────┤
│                  │ シナリオ基本情報              │
│ エラー表示       │  id: [________]              │
│ パネル           │  title: [________]           │
│ (リアルタイム   │  difficulty: [beginner ▼]   │
│  バリデーション) │  description: [________]     │
│                  │  objectives: [________]      │
│                  ├──────────────────────────────┤
│                  │ セクション一覧               │
│                  │ [+ 新規セクション]           │
│                  │                              │
│                  │ [> Section demo1] [✕]       │
│                  │ [> Section problem1] [✕]    │
│                  │ [> Section demo2] [✕]       │
│                  ├──────────────────────────────┤
│                  │ セクション詳細               │
│ プレビュー       │ (選択されたセクションの編集) │
│ パネル           │                              │
│ (盤面15x15)      │ type: [demo ▼]              │
│                  │ title: [________]            │
│                  │ initialBoard: [盤面エディタ] │
│                  │ ダイアログ/成功条件...       │
│                  ├──────────────────────────────┤
│                  │ [保存] [キャンセル]          │
└──────────────────┴──────────────────────────────┘
```

## 実装順序

1. ファイル操作（読み込み・保存）
2. シナリオ基本情報編集フォーム
3. 盤面ビジュアルエディタ（Konva実装）
4. デモセクション編集UI
5. 問題セクション編集UI
6. バリデーション表示
7. プレビュー機能
8. 細部調整・UX改善

## 使用ライブラリ

- Vue 3.x（既存）
- Konva（盤面表示・編集）
- parseScenario（バリデーション）

## ファイル構成

```
src/
  components/
    editor/
      ScenarioEditor.vue          # メインコンポーネント
      ScenarioEditorForm.vue      # 基本情報編集
      BoardVisualEditor.vue       # 盤面エディタ（Konva）
      SectionEditor.vue           # セクション編集
      DemoSectionEditor.vue       # デモセクション詳細編集
      ProblemSectionEditor.vue    # 問題セクション詳細編集
      PreviewPanel.vue            # プレビュー表示
      ValidationPanel.vue         # バリデーション結果表示
  logic/
    scenarioFileHandler.ts        # ファイル読み込み・保存
```

## その他必要な処理

### ボードアクション編集UI

- 現在のboardActionをサポート：place | remove | setBoard | mark | line
- 各タイプごとの入力フォーム
- ダイアログごとに0個または1個のboardAction

### キャラクター管理

- 既知のキャラクター一覧から選択可能
- 新しいキャラクターの追加も可能

### 座標入力補助

- row/col をスピナーで入力
- 盤面上のクリックで自動入力

### 文字列配列の編集

- objectives, moves等の配列を編集できるUI
- 行ごとに追加・削除

### テンプレート機能

- 新規シナリオ作成時のテンプレート
- 空のセクションテンプレート
