# CPU AIアルゴリズム

このドキュメントでは、CPU対戦機能で使用されるAIアルゴリズムの仕組みと調整方法について説明します。

## 概要

CPU AIは以下のアルゴリズムを組み合わせて実装されています:

- **Minimax探索**: 相手が最善手を打つと仮定し、最良の手を選択
- **Alpha-Beta剪定**: 不要な探索を省略して効率化
- **Iterative Deepening**: 時間制限内で段階的に深く探索
- **Transposition Table**: 同一局面の重複計算を回避
- **Move Ordering**: 候補手を優先度順にソートして剪定効率を向上

## 難易度調整パラメータ

難易度は `src/types/cpu.ts` の `DIFFICULTY_PARAMS` で定義されています。

| 難易度   | depth | timeLimit | randomFactor | maxNodes | scoreThreshold |
| -------- | ----- | --------- | ------------ | -------- | -------------- |
| beginner | 1     | 1000ms    | 0.80 (80%)   | 10,000   | 1200           |
| easy     | 2     | 2000ms    | 0.25 (25%)   | 50,000   | 200            |
| medium   | 3     | 4000ms    | 0.10 (10%)   | 200,000  | 150            |
| hard     | 4     | 8000ms    | 0.00 (0%)    | 600,000  | 0              |

### パラメータの意味

#### depth（探索深度）

何手先まで読むかを指定します。

- 値が大きいほど強くなるが、探索時間が指数関数的に増加
- Iterative Deepeningにより、時間制限内で到達可能な深度まで探索

#### timeLimit（時間制限）

1手あたりの最大思考時間（ミリ秒）です。

- 探索は時間制限の50%を超えた時点で次の深度への移行を中断
- 時間内に完了した最深の探索結果を使用

#### randomFactor（ランダム要素）

AIの着手にランダム性を加える確率です。

- `randomFactor > 0` の場合、その確率で上位N手（候補数の1/3程度）からランダム選択
- beginner/easyでは意図的に「最善手でない手」を打つことで弱く見せる
- medium/hardでは0（常に最善手を選択）

## 評価関数

評価関数は `src/logic/cpu/evaluation.ts` に実装されています。

### パターンスコア

石のパターンを検出し、スコアを付与します:

| パターン       | スコア  | 説明                                      |
| -------------- | ------- | ----------------------------------------- |
| FIVE           | 100,000 | 五連（勝利）                              |
| OPEN_FOUR      | 10,000  | 活四（両端が開いた四連）                  |
| FOUR           | 1,000   | 止め四（片端のみ開）                      |
| OPEN_THREE     | 1,000   | 活三（両端が開いた三連）                  |
| OPEN_TWO       | 50      | 活二                                      |
| THREE          | 30      | 止め三（片端のみ開）※剣先問題により低評価 |
| TWO            | 10      | 止め二                                    |
| CENTER_BONUS   | 5       | 中央寄りボーナス                          |
| FORBIDDEN_TRAP | 100     | 禁じ手誘導ボーナス                        |

### 評価の計算方法

1. **攻撃スコア**: 自分のパターンスコアの合計
2. **防御スコア**: 相手がその位置に置いた場合のスコア × 0.5（ブロック価値）
3. **中央ボーナス**: 天元(7,7)からの距離に基づくボーナス

```
総合スコア = 攻撃スコア + 防御スコア + 中央ボーナス
```

盤面全体の評価は:

```
盤面スコア = 自分のパターンスコア合計 - 相手のパターンスコア合計
```

## 探索の最適化

### Iterative Deepening（段階的深化）

`findBestMoveIterativeWithTT()` で実装。

1. 深さ1から探索を開始
2. 時間制限内で可能な限り深く探索
3. 各深度の結果を保存し、時間切れの場合は最後に完了した深度の結果を使用

**メリット**:

- 時間制限を守りながら最大限深く探索
- 浅い探索の結果を深い探索のMove Orderingに活用

### Move Ordering（候補手の優先順位）

`src/logic/cpu/moveGenerator.ts` の `sortMoves()` で実装。

優先度（高い順）:

1. **TT最善手** (+1,000,000): 置換表に記録された最善手
2. **Killer Moves** (+100,000〜90,000): 同じ深さで剪定を引き起こした手
3. **静的評価**: `evaluatePosition()` による攻撃・防御価値
4. **History Heuristic**: 過去に剪定を引き起こした手の統計

**Killer Moves**:

- 各深度で最大2つの手を記録
- Beta cutoffを引き起こした手は、同じ深度の他の局面でも有効な可能性が高い

**History Heuristic**:

- cutoffを引き起こした手の位置に `depth²` のスコアを加算
- 深い探索でのcutoffほど重要として扱う

### Transposition Table（置換表）

`src/logic/cpu/transpositionTable.ts` で実装。

同一局面の重複計算を回避するキャッシュ。異なる手順で同じ局面に到達した場合、以前の計算結果を再利用します。

**エントリの内容**:

- `hash`: 盤面のZobristハッシュ
- `score`: 評価スコア
- `depth`: 探索深度
- `type`: スコアタイプ（EXACT / LOWER_BOUND / UPPER_BOUND）
- `bestMove`: この局面での最善手
- `generation`: 世代番号（古いエントリ置換用）

**置換戦略**:

- 新しいエントリの深度が深い場合は置換
- 既存エントリが古い世代の場合は置換
- EXACT（正確な評価値）は優先的に保持

**サイズ管理**:

- 最大100万エントリ
- 上限超過時は古い世代のエントリを優先的に削除

### Zobrist Hashing

`src/logic/cpu/zobrist.ts` で実装。

盤面を高速にハッシュ化する手法。XOR演算により差分更新が可能で、石を置くたびに全盤面を再計算する必要がありません。

**仕組み**:

1. 各位置・各色に対してユニークな64ビット乱数を事前生成
2. 盤面ハッシュは、すべての石のZobrist値をXORした結果
3. 石を置く/取る操作は、該当位置のZobrist値とXORするだけ

```
新ハッシュ = 現在のハッシュ XOR Zobrist[row][col][color]
```

## 特殊処理

### 開局フェーズ（珠型パターン）

`src/logic/cpu/opening.ts` で実装。

連珠では最初の3手に定型パターン（珠型）があります:

1. **1手目（黒）**: 天元(7,7)に置く
2. **2手目（白）**: 天元の周囲8マスからランダムに選択
3. **3手目（黒）**: 白の位置に応じた珠型パターンからランダムに選択

**珠型パターン**:

- **直打ち（斜め）**: 寒星、花月、雨月、金星、松月、丘月、新月、瑞星、山月、遊星、彗星、残月、明星
- **間打ち（縦横）**: 瑞星、山月、溪月、寒星、水月、流星、雲月、浦月、峡月、岩月、銀月、名月、恒星

4手目以降は通常のMinimax探索に移行します。

### 禁手チェック

黒番では禁手（三三禁、四四禁、長連禁）をチェックし、禁手となる位置は候補手から除外します。ただし、五連が作れる場合は禁手でも候補に含めます（五連は禁手より優先）。

## 調整ガイドライン

### 難易度を変更する場合

| 変更内容                 | 効果                             |
| ------------------------ | -------------------------------- |
| depth を増やす           | より強く（ただし思考時間が増加） |
| timeLimit を増やす       | 深い探索が完了する確率が上がる   |
| randomFactor を増やす    | より弱く（意図的にミスを増やす） |
| randomFactor を 0 にする | 常に最善手を選択（安定した強さ） |

### 評価関数を調整する場合

| 変更内容                 | 効果                                 |
| ------------------------ | ------------------------------------ |
| OPEN_FOUR を高くする     | 活四をより重視（攻撃的になる）       |
| FOUR/THREE を高くする    | 止め四/三をより重視                  |
| 防御スコアの係数を上げる | 相手の攻撃をより警戒（守備的になる） |
| CENTER_BONUS を高くする  | より中央寄りに打つ傾向               |

## 実装済み機能

連珠の戦術・ルールに基づく以下の機能が実装されています。

### パターン検出

#### 跳び三・跳び四の検出

1マス空いた形も連続パターンと同等の脅威として検出。

| パターン | 形の例           | スコア            |
| -------- | ---------------- | ----------------- |
| 跳び四   | `●●●_●`, `●●_●●` | FOUR (1000)       |
| 活跳び三 | `_●●_●_`         | OPEN_THREE (1000) |

`renjuRules.ts` の `checkJumpFour()`, `checkJumpThree()` で実装。

#### 四三同時作成ボーナス

四と活三を同時に作る手に +5000 ボーナス。

```
OPEN_FOUR(10000) + OPEN_THREE(1000) + FOUR_THREE_BONUS(5000) = 16000
```

### 白番の特殊評価

#### 白の三三・四四を勝利扱い

白には禁手がないため、活三が2つ以上または四が2つ以上あれば FIVE (100000) と同等に評価。

#### 禁手追い込み評価

| 状況                     | スコア                       |
| ------------------------ | ---------------------------- |
| 黒の防御位置が禁手       | FORBIDDEN_TRAP_STRONG (8000) |
| 禁手への誘導セットアップ | FORBIDDEN_TRAP_SETUP (1500)  |

### 先読み評価

#### ミセ手

次の手で四三を作れる位置に +1000 ボーナス（MISE_BONUS）。

#### フクミ手（VCF探索）

次にVCF（四追い勝ち）がある手に +1500 ボーナス（FUKUMI_BONUS）。
`vcf.ts` で深さ8手までのVCF探索を実装。

#### VCT探索

三・四を連続して打つ勝利手順を探索。終盤（石数20個以上）限定で +8000 ボーナス。
`vct.ts` で深さ4手までのVCT探索を実装。

### その他のボーナス

#### 複数方向脅威ボーナス

2方向以上で活三/四を作る手に +500×(方向数-1) ボーナス。

#### カウンターフォー

防御しながら四を作る手は防御スコア ×1.5。

#### 斜め方向ボーナス

斜め方向のパターンに +5% ボーナス（隣接空き点が多く効率が良い）。

### 開局データ

珠型ごとの有利不利を `JUSHU_EVALUATION` として定義（知識として保持）。

| 珠型       | 評価値         |
| ---------- | -------------- |
| 花月、浦月 | +500（黒必勝） |
| 疎星、流星 | +300（黒有利） |
| 寒星など   | -200（白有利） |

※ 現在は評価には未使用（競技連珠では開局規定で均等化されるため）

### 難易度別の機能制限

計算コストの高い機能は難易度に応じて有効/無効化:

| 機能             | beginner | easy    | medium  | hard     |
| ---------------- | -------- | ------- | ------- | -------- |
| 必守防御         | ❌       | ✅      | ✅      | ✅       |
| ミセ手           | ❌       | ❌      | ✅      | ✅       |
| フクミ手（VCF）  | ❌       | ❌      | ✅      | ✅       |
| 禁手追い込み     | ❌       | ❌      | ❌      | ✅       |
| 複数方向脅威     | ❌       | ❌      | ✅      | ✅       |
| カウンターフォー | ❌       | ❌      | ✅      | ✅       |
| VCT探索          | ❌       | ❌      | ❌      | ✅       |
| 単発四ペナルティ | ❌       | ✅(40%) | ✅(70%) | ✅(100%) |
| ミセ手脅威防御   | ❌       | ❌      | ✅      | ✅       |

## 探索の高速化

### 動的時間配分

局面に応じて思考時間を調整し、無駄な計算を削減。

| 状況            | 時間配分     |
| --------------- | ------------ |
| 序盤（6手以下） | 基本時間×0.5 |
| 候補手が3つ以下 | 基本時間×0.3 |
| 唯一の候補手    | 即座に返す   |

### Late Move Reductions (LMR)

Move Orderingで後半に来る手（5番目以降）は浅く探索し、有望な結果なら再探索。

```
パラメータ:
- LMR_MOVE_THRESHOLD: 4（5手目以降に適用）
- LMR_MIN_DEPTH: 3（深度3以上で適用）
- LMR_REDUCTION: 1（探索深度を1浅くする）
```

### Aspiration Windows

前回の探索結果をもとに、alpha-betaの初期ウィンドウを狭める。

```
パラメータ:
- ASPIRATION_WINDOW: 50（ウィンドウ幅）
```

ウィンドウ外の結果が出たら、フルウィンドウで再探索。

## 将来の改善（未実装）

### 難易度調整

現在の `randomFactor` は「上位N手からランダム選択」のため、beginner でも致命的なミスをしにくい。より弱い難易度を実現するには以下の改善が考えられる:

1. **全候補手からのランダム選択**: 上位1/3ではなく全候補手から選ぶオプション
2. **評価スコアへのノイズ追加**: 評価関数にランダムノイズを加えて判断を曖昧にする
3. **意図的な悪手選択**: 一定確率で下位の手を選ぶ仕組み
4. **探索深度1**: beginner は深度1にして先読みをほぼ無効化

### 探索アルゴリズム

1. **Null Move Pruning**: 自分がパスしても有利なら枝刈り
2. **Futility Pruning**: 静的評価がalphaを大幅に下回る局面をスキップ
3. **Opening Book**: 定石データベースの導入
4. **Pondering（先読み）**: プレイヤーの思考中にバックグラウンドで探索

### 着手優先順位の改善

- mediumでもプレイヤーの三を見逃してしまうことがある
- ~~四伸びの評価が高すぎるのか、無駄な四伸びを打ちがち~~ → **解決済み**: 単発四ペナルティを実装。後続脅威（VCF）がない単独の四は、medium で 90%、hard で 100% 減点される

## ファイル構成

| ファイル                    | 役割                                 |
| --------------------------- | ------------------------------------ |
| `types/cpu.ts`              | 難易度パラメータ、型定義             |
| `cpu/minimax.ts`            | Minimax探索、Iterative Deepening     |
| `cpu/evaluation.ts`         | 評価関数、パターンスコア             |
| `cpu/moveGenerator.ts`      | 候補手生成、Move Ordering            |
| `cpu/transpositionTable.ts` | 置換表                               |
| `cpu/zobrist.ts`            | Zobristハッシュ                      |
| `cpu/opening.ts`            | 開局処理（珠型パターン、評価データ） |
| `cpu/vcf.ts`                | VCF（四追い勝ち）探索                |
| `cpu/vct.ts`                | VCT（三・四連続勝ち）探索            |
