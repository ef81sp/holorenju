# ベンチマーク分析レポート 2026-02-04-2

**ファイル**: `bench-2026-02-04T23-35-51-934Z.json`

## 変更概要

探索アルゴリズムの最適化（禁手判定キャッシュ、Undo方式、遅延禁手判定）を実施。ゲーム数を60→120に増加。

## 難易度別レーティング結果

| 難易度   | レーティング | 成績       | 勝率 | 前回比較 |
| -------- | ------------ | ---------- | ---- | -------- |
| hard     | 1708         | 50W-10L-0D | 83%  | -39      |
| medium   | 1613         | 38W-22L-0D | 63%  | +68      |
| easy     | 1405         | 22W-38L-0D | 36%  | +46      |
| beginner | 1272         | 10W-50L-0D | 16%  | -82      |

**備考**: 前回（2026-02-04T17時）のベンチマークとの比較。ゲーム数が60→120に増加したため、単純比較には注意。

## レーティング差（隣接難易度間）

| 区間            | 今回 | 前回（17時版） | 評価           |
| --------------- | ---- | -------------- | -------------- |
| hard - medium   | 94   | 195            | 差が縮小       |
| medium - easy   | 208  | 185            | 適切な差を維持 |
| easy - beginner | 132  | 4              | **大幅改善**   |

**注目点**: easy-beginner間の差が4→132に改善。beginnerの改善により明確な階層化が進んだ。

## 難易度別探索統計

| 難易度   | 着手数 | 平均ノード | 最大ノード | 平均深度 | 設定深度 | 中断率 |
| -------- | ------ | ---------- | ---------- | -------- | -------- | ------ |
| beginner | 655    | 27         | 135        | 0.7      | 1        | -      |
| easy     | 707    | 225        | 1,269      | 1.4      | 2        | -      |
| medium   | 632    | 886        | 10,079     | 1.9      | 3        | 100%   |
| hard     | 791    | 13,710     | 90,383     | 2.8      | 4        | 100%   |

**注目点**: hardの平均ノードが8,092→13,710に増加（最適化により同一時間でより深い探索が可能に）。

## 難易度別探索効率

| 難易度   | TTヒット率 | Beta cutoff率 |
| -------- | ---------- | ------------- |
| beginner | 62.9%      | 0%            |
| easy     | 26.3%      | 17.4%         |
| medium   | 21.5%      | 19.0%         |
| hard     | 28.8%      | 27.5%         |

**前回比較**:

- TTヒット率: beginner 55.7%→62.9%(+7.2pt), hard 22.5%→28.8%(+6.3pt)
- Beta cutoff率は概ね同水準

## 難易度別詳細プロファイリング

| 難易度   | 禁手判定回数 | ノード比 | 盤面コピー | ノード比 |
| -------- | ------------ | -------- | ---------- | -------- |
| beginner | 177,684      | 9.8      | 262,332    | 14.5     |
| easy     | 359,364      | 2.2      | 492,025    | 3.0      |
| medium   | 13,577,906   | 24.2     | 11,735,261 | 20.9     |
| hard     | 23,650,472   | 2.1      | 2,724,343  | 0.2      |

**注目点**: hardの盤面コピー/ノード比が0.2と大幅に低下（Undo方式最適化の効果）。

## 難易度別選択順位分布

| 難易度   | R1  | R2  | R3  | R4  | R5  | 候補外 |
| -------- | --- | --- | --- | --- | --- | ------ |
| beginner | 301 | 61  | 26  | 4   | 1   | 70     |
| easy     | 368 | 29  | 16  | 11  | 6   | 67     |
| medium   | 393 | 12  | 4   | 2   | 0   | 9      |
| hard     | 575 | 0   | 0   | 0   | 0   | 0      |

**R1選択率**:

- beginner: 65% (301/463)
- easy: 74% (368/497)
- medium: 94% (393/420)
- hard: 100% (575/575)

## 難易度別ランダム悪手（スコア差500以上）

| 難易度   | 回数 |
| -------- | ---- |
| beginner | 0    |
| easy     | 0    |
| medium   | 0    |
| hard     | 0    |

## 難易度別禁手負け

| 難易度   | 回数 | 詳細                                        |
| -------- | ---- | ------------------------------------------- |
| beginner | 3    | game2, game16 (vs easy), game34 (vs medium) |
| easy     | 0    | -                                           |
| medium   | 1    | game118 (vs hard, 17手)                     |
| hard     | 0    | -                                           |

**禁手負け詳細**:

- game2: beginner（黒）がeasyに追い込まれ禁手負け（23手）
- game16: beginner（黒）がeasyに追い込まれ禁手負け（19手）
- game34: beginner（黒）がmediumに追い込まれ禁手負け（13手）
- game118: medium（黒）がhardに追い込まれ禁手負け（17手）

## 先手/後手バランス

| 指標     | 結果           | 評価 |
| -------- | -------------- | ---- |
| 黒勝利   | 63 (52%)       | 正常 |
| 白勝利   | 57 (47%)       | 正常 |
| 勝利理由 | five 96.7%     | 正常 |
|          | forbidden 3.3% | 正常 |

## ゲーム長統計

| 指標     | 値   |
| -------- | ---- |
| 平均手数 | 26手 |
| 最短     | 13手 |
| 最長     | 62手 |

## 難易度別平均思考時間

| 難易度   | 平均思考時間 |
| -------- | ------------ |
| beginner | 18ms         |
| easy     | 48ms         |
| medium   | 302ms        |
| hard     | 1,595ms      |

## 問題点・改善提案

### 1. hard-medium間のレーティング差が縮小

- 前回195→今回94と差が縮まっている
- hardの勝率が93%→83%に低下
- **原因仮説**: サンプル数増加による統計的安定化、またはmediumの実力向上
- **提案**: hardのtimeLimitを増加（現状の2倍程度）して探索深度を上げることを検討

### 2. medium/hardの中断率100%

- 設定深度到達前に時間切れとなるケースが多い
- **提案**:
  - medium: timeLimit 1000ms → 1500msを検討
  - hard: timeLimit 5000ms → 7000msを検討

### 3. beginnerの禁手負け

- 3回の禁手負け（全てeasy/mediumに追い込まれた）
- **評価**: 弱い難易度として適切な挙動。修正不要。

### 4. mediumのプロファイリング異常（原因特定済み）

**現象**: 盤面コピー/ノード比が20.9と他難易度より高い

**詳細分析結果**:

| ノード数範囲 | medium着手数 | 平均盤面コピー | hard比較 |
| ------------ | ------------ | -------------- | -------- |
| nodes<100    | 220          | **59,268**     | 2,739    |
| 100≤nodes<1k | 192          | 2,136          | -        |
| 1k≤nodes<10k | 219          | 3,813          | 3,618    |
| nodes≥10k    | 1            | 1,894          | 5,294    |

**原因特定**: VCF探索（`findFourMoves`, `findVCFMove`）での大量の盤面コピー

VCF探索は各空きセルに対して`copyBoard`を呼び出す実装（`vcf.ts:250`）となっており、
再帰的なVCF探索（深度最大8）で盤面コピーが指数関数的に増加する。

特に問題のある着手の例:

- nodes=4, depth=1 で盤面コピー10,485,436回（禁手判定10,217,163回）
- これはVCF探索が非常に深くまで探索した結果

**mediumが影響を受けやすい理由**:

- mediumは探索が浅く終わりやすい（timeLimit短い、maxNodes少ない）
- VCF/脅威検出などルートレベル処理で決定される着手の比率が高い
- hardは深い探索を行うため、VCF探索結果の影響が相対的に小さい

**改善提案**:

1. `vcf.ts`の`findFourMoves`をUndo方式に最適化
2. VCF探索の盤面コピーを削減することで、全難易度のパフォーマンス向上が期待できる

## 結論

探索アルゴリズムの最適化（Zobristハッシュキャッシュ、Undo方式）により、以下の改善が確認された:

### 良い点

1. **hardの探索効率向上**: 平均ノード数が8,092→13,710に増加し、同一時間でより深い探索が可能に
2. **easy-beginner間の階層化改善**: レーティング差4→132と明確な差が生まれた
3. **TTヒット率向上**: 全難易度で改善（beginner +7.2pt, hard +6.3pt）
4. **hardの盤面コピー削減**: ノード比が大幅に低下（Undo方式の効果）

### 懸念点

1. **hard-medium間の差縮小**: 195→94と差が半減。サンプル増加による安定化か要観察
2. **VCF探索での大量盤面コピー**: `findFourMoves`がUndo方式未適用で、各空きセルに対してcopyBoardを呼び出す実装となっている

### 次のアクション

1. **VCF探索のUndo方式最適化**: `vcf.ts`の`findFourMoves`と`findVCFMove`を最適化
   - 現状: 各候補位置で`copyBoard`呼び出し（空きセル数×再帰深度の盤面コピー）
   - 改善: インプレース変更＋Undo方式に変更
2. hard/mediumのtimeLimit増加を検討
3. ゲーム数120でのベンチマークを追加実施し、レーティングの安定性を確認
