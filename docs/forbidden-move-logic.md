# 禁手ロジック完全実装

## 概要

CPU対戦機能の前提として、禁手判定ロジックを完全実装する。

**実装方針**: TDD（Red-Green-Refactor）

## 現在の問題点

`src/logic/renjuRules.ts` の現在の実装には以下の問題がある：

1. **飛び三・飛び四が検出されていない** - `●●・●` のような飛び型パターンを検出できない
2. **「ウソの三」が考慮されていない** - 達四点が禁点なら三として認定してはいけない
3. **「否三々」が実装されていない** - 相互参照する禁点の再帰的判定が必要

## 用語定義（RIFルール準拠）

| 用語         | 定義                                                   |
| ------------ | ------------------------------------------------------ |
| **達四**     | 両端が開いている4連（`・●●●●・`）。2点から五連を作れる |
| **四**       | 1個加えると五連になる形。達四・跳四・止四を含む        |
| **三**       | 1個加えると**達四**になる形（単なる四ではない）        |
| **ウソの三** | 達四点がすべて禁点の場合、三として認定しない           |
| **否三々**   | 相互参照で禁手が成立しないケース                       |

## 飛び型パターン

### 飛び三（1つの空きで3石）

```
・・●●・●・・  →  ●●・● 型（右飛び）
・・●・●●・・  →  ●・●● 型（左飛び）
```

### 飛び四（1つの空きで4石）

```
・●●●・●・  →  ●●●・● 型
・●●・●●・  →  ●●・●● 型
・●・●●●・  →  ●・●●● 型
```

## TDDサイクル

### Cycle 1: 飛び三の検出

**Red** - テストを書く:

```typescript
describe("飛び三の検出", () => {
  it("●●・● パターン（右飛び）を検出", () => {
    // ・・●●・●・・ (row=7, cols 5,6,_,8)
    // col=7に置くと飛び三
  });

  it("●・●● パターン（左飛び）を検出", () => {
    // ・・●・●●・・ (row=7, cols 5,_,7,8)
    // col=6に置くと飛び三
  });

  it("飛び三が2つで三々禁になる", () => {
    // 横と縦に飛び三パターン
  });
});
```

**Green** - 最小限の実装

**Refactor** - コードの整理

### Cycle 2: 飛び四の検出

**Red** - テストを書く:

```typescript
describe("飛び四の検出", () => {
  it("●●●・● パターンを検出", () => {});
  it("●●・●● パターンを検出", () => {});
  it("●・●●● パターンを検出", () => {});
  it("飛び四が2つで四四禁になる", () => {});
});
```

**Green** - 実装

**Refactor** - 飛び三と飛び四の共通ロジックを抽出

### Cycle 3: ウソの三の判定

**Red** - テストを書く:

```typescript
describe("ウソの三", () => {
  it("達四点が四四禁なら三として認定しない", () => {});
  it("達四点が長連禁なら三として認定しない", () => {});
  it("達四点が1つでも有効なら三として認定", () => {});
});
```

**Green** - 実装:

- `getStraightFourPoints()` - 達四点を列挙
- `isValidThree()` - 達四点が禁点かチェック
- 再帰的な `checkForbiddenMoveRecursive()` を導入

**Refactor** - キャッシュ機構の導入

### Cycle 4: 否三々の判定

**Red** - テストを書く:

```typescript
describe("否三々", () => {
  it("A点の禁手がB点の三を無効にする場合、B点は禁手ではない", () => {});
  it("循環参照がない通常の三々は禁手", () => {});
});
```

**Green** - 実装:

- `ForbiddenCache` に `inProgress` フラグを追加
- 循環参照検出時は「禁点ではない」として扱う

**Refactor** - 統合テストの追加

## アルゴリズム

```
checkForbiddenMove(board, row, col)
├── 1. 空きマスチェック
├── 2. 五連チェック → 五連なら禁手ではない
├── 3. 長連チェック → 6連以上は禁手
├── 4. 四四チェック
│   └── detectAllFours() - 連続四 + 飛び四
└── 5. 三三チェック
    └── detectAllThrees() - 連続三 + 飛び三
        └── isValidThree() - ウソの三を除外
            └── 達四点が禁点か再帰チェック
```

## 修正ファイル

| ファイル                       | 変更内容                   |
| ------------------------------ | -------------------------- |
| `src/logic/renjuRules.ts`      | 禁手判定ロジックを完全実装 |
| `src/logic/renjuRules.test.ts` | TDDテストケースを追加      |

## 検証

```bash
pnpm test src/logic/renjuRules.test.ts
```

## 参考資料

- [連珠(五目並べ)入門 for プログラマ - Qiita](https://qiita.com/YSRKEN/items/81f97660be023add2265)
- [RIF Rules - RenjuNet](https://www.renju.net/rifrules/)
